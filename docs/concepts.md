# Концепции (Concepts)

Это руководство объясняет основные идеи, лежащие в основе OpenSpec, и то, как они взаимосвязаны. Для практического использования см. разделы [Начало работы](getting-started.md) и [Процессы](workflows.md).

## Философия

OpenSpec строится на четырех принципах:

```
гибкость, а не жесткость — никаких фазовых шлюзов, работайте над тем, что важно
итеративность, а не водопад — учитесь в процессе сборки, уточняйте по ходу дела
простота, а не сложность — легкая настройка, минимум церемоний
сначала brownfield — работает с существующими кодовыми базами, а не только с новыми
```

### Почему эти принципы важны

**Гибкость, а не жесткость.** Традиционные системы спецификаций привязывают вас к фазам: сначала вы планируете, затем реализуете, затем завершаете. OpenSpec более гибок — вы можете создавать артефакты в любом порядке, который имеет смысл для вашей работы.

**Итеративность, а не водопад.** Требования меняются. Понимание углубляется. То, что казалось хорошим подходом в начале, может не выдержать проверки кодом. OpenSpec принимает эту реальность.

**Простота, а не сложность.** Некоторые фреймворки спецификаций требуют сложной настройки, жестких форматов или тяжеловесных процессов. OpenSpec не мешает вам. Инициализируйте за секунды, начинайте работать немедленно, кастомизируйте только если это необходимо.

**Сначала brownfield.** Большинство задач в разработке — это не создание с нуля, а модификация существующих систем. Дельта-ориентированный подход OpenSpec позволяет легко специфицировать изменения в существующем поведении, а не только описывать новые системы.

## Общая картина

OpenSpec организует вашу работу в две основные области:

```
┌─────────────────────────────────────────────────────────────────┐
│                        openspec/                                 │
│                                                                  │
│   ┌─────────────────────┐      ┌──────────────────────────────┐ │
│   │       specs/        │      │         changes/              │ │
│   │                     │      │                               │ │
│   │  Источник истины    │◄─────│  Предлагаемые модификации     │ │
│   │  Как ваша система   │слияние│  Каждое изменение = одна папка│ │
│   │  сейчас работает    │      │  Содержит артефакты + дельты  │ │
│   │                     │      │                               │ │
│   └─────────────────────┘      └──────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Спецификации (Specs)** — это источник истины, они описывают текущее поведение вашей системы.

**Изменения (Changes)** — это предлагаемые модификации, которые живут в отдельных папках до тех пор, пока вы не будете готовы их объединить.

Это разделение является ключевым. Вы можете работать над несколькими изменениями параллельно без конфликтов. Вы можете проверить изменение до того, как оно повлияет на основные спецификации. И когда вы архивируете изменение, его дельты чисто вливаются в источник истины.

## Спецификации (Specs)

Спецификации описывают поведение вашей системы с использованием структурированных требований и сценариев.

### Структура

```
openspec/specs/
├── auth/
│   └── spec.md           # Поведение аутентификации
├── payments/
│   └── spec.md           # Обработка платежей
├── notifications/
│   └── spec.md           # Система уведомлений
└── ui/
    └── spec.md           # Поведение UI и темы
```

Организуйте спецификации по доменам — логическим группам, которые имеют смысл для вашей системы. Распространенные паттерны:

- **По функциональным областям**: `auth/`, `payments/`, `search/`
- **По компонентам**: `api/`, `frontend/`, `workers/`
- **По ограниченным контекстам (bounded contexts)**: `ordering/`, `fulfillment/`, `inventory/`

### Формат спецификаций

Спецификация содержит требования, и каждое требование имеет сценарии:

```markdown
# Спецификация Auth

## Цель
Аутентификация и управление сессиями для приложения.

## Требования

### Требование: Аутентификация пользователя
Система ДОЛЖНА выдавать JWT-токен при успешном входе.

#### Сценарий: Верные учетные данные
- ДАНО: пользователь с верными учетными данными
- КОГДА: пользователь отправляет форму входа
- ТОГДА: возвращается JWT-токен
- И: пользователь перенаправляется на дашборд

#### Сценарий: Неверные учетные данные
- ДАНО: неверные учетные данные
- КОГДА: пользователь отправляет форму входа
- ТОГДА: отображается сообщение об ошибке
- И: токен не выдается

### Требование: Истечение срока сессии
Система ДОЛЖНА аннулировать сессии после 30 минут бездействия.

#### Сценарий: Тайм-аут при бездействии
- ДАНО: аутентифицированная сессия
- КОГДА: проходит 30 минут без активности
- ТОГДА: сессия становится недействительной
- И: пользователь должен снова пройти аутентификацию
```

**Ключевые элементы:**

| Элемент | Назначение |
|---------|---------|
| `## Цель` | Высокоуровневое описание области этой спецификации |
| `### Требование:` | Конкретное поведение, которым должна обладать система |
| `#### Сценарий:` | Конкретный пример реализации требования в действии |
| SHALL/MUST/SHOULD | Ключевые слова RFC 2119, указывающие на строгость требования |

### Почему спецификации структурированы именно так

**Требования — это "Что"** — они формулируют, что система должна делать, без указания реализации.

**Сценарии — это "Когда"** — они предоставляют конкретные примеры, которые можно проверить. Хорошие сценарии:
- Тестируемы (вы могли бы написать для них автоматизированный тест).
- Охватывают как основной сценарий (happy path), так и граничные случаи.
- Используют формат Дано/Когда/Тогда (Given/When/Then) или аналогичный структурированный формат.

**Ключевые слова RFC 2119** (SHALL, MUST, SHOULD, MAY) передают намерение:
- **MUST/SHALL (ДОЛЖНА)** — абсолютное требование.
- **SHOULD (СЛЕДУЕТ)** — рекомендуется, но могут быть исключения.
- **MAY (МОЖЕТ)** — опционально.

## Изменения (Changes)

Изменение — это предлагаемая модификация вашей системы, упакованная в папку со всем необходимым для её понимания и реализации.

### Структура изменения

```
openspec/changes/add-dark-mode/
├── proposal.md           # Почему и Что
├── design.md             # Как (технический подход)
├── tasks.md              # Список задач для реализации
├── .openspec.yaml        # Метаданные изменения (опционально)
└── specs/                # Дельта-спецификации
    └── ui/
        └── spec.md       # Что меняется в ui/spec.md
```

Каждое изменение самодостаточно. Оно содержит:
- **Артефакты** — документы, фиксирующие намерения, дизайн и задачи.
- **Дельта-спецификации** — описание того, что добавляется, изменяется или удаляется.
- **Метаданные** — опциональная конфигурация для этого конкретного изменения.

### Почему изменения — это папки

Упаковка изменения в виде папки дает несколько преимуществ:

1. **Все вместе.** Предложение, дизайн, задачи и спецификации живут в одном месте. Не нужно искать их по разным локациям.

2. **Параллельная работа.** Несколько изменений могут существовать одновременно без конфликтов. Работайте над `add-dark-mode`, пока `fix-auth-bug` также находится в процессе.

3. **Чистая история.** При архивации изменения перемещаются в `changes/archive/` с сохранением полного контекста. Вы можете оглянуться назад и понять не только что изменилось, но и почему.

4. **Удобство обзора.** Папку изменения легко рецензировать — откройте её, прочитайте предложение, проверьте дизайн, посмотрите дельты спецификаций.

## Артефакты

Артефакты — это документы внутри изменения, которые направляют работу.

### Поток артефактов

```
предложение ──────► спецификации ──────► дизайн ──────► задачи ──────► реализация
      │               │                   │              │
    почему           что                 как            шаги
  + объем         изменения            подход         которые нужно предпринять
```

Артефакты строятся друг на друге. Каждый артефакт предоставляет контекст для следующего.

### Типы артефактов

#### Предложение (`proposal.md`)

Предложение фиксирует **намерения**, **объем** и **подход** на высоком уровне.

```markdown
# Предложение: Добавить темную тему

## Намерение
Пользователи запрашивали возможность включения темной темы для снижения 
нагрузки на глаза в ночное время и соответствия системным предпочтениям.

## Объем
В рамках задачи:
- Переключатель темы в настройках
- Определение системных предпочтений
- Сохранение предпочтений в localStorage

Вне рамок:
- Пользовательские цветовые темы (будущая работа)
- Переопределение темы для отдельных страниц

## Подход
Использовать CSS-переменные для темизации и React context для управления 
состоянием. Определять системные предпочтения при первой загрузке, 
позволять ручное переопределение.
```

**Когда обновлять предложение:**
- Изменяется объем (сужается или расширяется).
- Проясняются намерения (лучшее понимание проблемы).
- Принципиально меняется подход.

#### Спецификации (дельта-спецификации в `specs/`)

Дельта-спецификации описывают, **что меняется** относительно текущих спецификаций. См. раздел [Дельта-спецификации](#дельта-спецификации) ниже.

#### Дизайн (`design.md`)

Дизайн фиксирует **технический подход** и **архитектурные решения**.

```markdown
# Дизайн: Добавить темную тему

## Технический подход
Состояние темы управляется через React Context, чтобы избежать проброса пропсов (prop drilling).
CSS-переменные позволяют переключать тему в рантайме без смены классов.

## Архитектурные решения

### Решение: Context вместо Redux
Использование React Context для состояния темы, потому что:
- Простое бинарное состояние (светлая/темная)
- Нет сложных переходов состояний
- Позволяет избежать добавления зависимости Redux

### Решение: CSS-переменные
Использование CSS-переменных вместо CSS-in-JS, потому что:
- Работает с существующими таблицами стилей
- Нет накладных расходов во время выполнения
- Нативное решение браузера

## Поток данных
```
ThemeProvider (context)
       │
       ▼
ThemeToggle ◄──► localStorage
       │
       ▼
CSS Variables (applied to :root)
```

## Изменения файлов
- `src/contexts/ThemeContext.tsx` (новый)
- `src/components/ThemeToggle.tsx` (новый)
- `src/styles/globals.css` (изменен)
```

**Когда обновлять дизайн:**
- Реализация показала, что подход не сработает.
- Найдено лучшее решение.
- Изменились зависимости или ограничения.

#### Задачи (`tasks.md`)

Задачи — это **чек-лист реализации**, конкретные шаги с флажками.

```markdown
# Задачи

## 1. Инфраструктура тем
- [ ] 1.1 Создать ThemeContext с состояниями light/dark
- [ ] 1.2 Добавить CSS-переменные для цветов
- [ ] 1.3 Реализовать сохранение в localStorage
- [ ] 1.4 Добавить определение системных предпочтений

## 2. UI Компоненты
- [ ] 2.1 Создать компонент ThemeToggle
- [ ] 2.2 Добавить переключатель на страницу настроек
- [ ] 2.3 Обновить Header, включив быстрый переключатель

## 3. Стилизация
- [ ] 3.1 Определить палитру цветов для темной темы
- [ ] 3.2 Обновить компоненты для использования CSS-переменных
- [ ] 3.3 Проверить коэффициенты контрастности для доступности
```

**Лучшие практики для задач:**
- Группируйте связанные задачи под заголовками.
- Используйте иерархическую нумерацию (1.1, 1.2 и т.д.).
- Делайте задачи достаточно мелкими, чтобы их можно было выполнить за одну сессию.
- Отмечайте задачи по мере их выполнения.

## Дельта-спецификации

Дельта-спецификации — это ключевая концепция, которая позволяет OpenSpec работать с существующими проектами (brownfield). Они описывают, **что меняется**, а не пересказывают всю спецификацию целиком.

### Формат

```markdown
# Дельта для Auth

## ДОБАВЛЕННЫЕ требования

### Требование: Двухфакторная аутентификация
Система ДОЛЖНА поддерживать двухфакторную аутентификацию на основе TOTP.

#### Сценарий: Регистрация 2FA
- ДАНО: пользователь с отключенным 2FA
- КОГДА: пользователь включает 2FA в настройках
- ТОГДА: отображается QR-код для настройки приложения-аутентификатора
- И: пользователь должен подтвердить активацию кодом

#### Сценарий: Вход с 2FA
- ДАНО: пользователь с включенным 2FA
- КОГДА: пользователь вводит верные учетные данные
- ТОГДА: предъявляется запрос OTP
- И: вход завершается только после ввода верного OTP

## ИЗМЕНЕННЫЕ требования

### Требование: Тайм-аут сессии
Система ДОЛЖНА аннулировать сессии после 15 минут бездействия.
(Ранее: 30 минут)

#### Сценарий: Тайм-аут при бездействии
- ДАНО: аутентифицированная сессия
- КОГДА: проходит 15 минут без активности
- ТОГДА: сессия становится недействительной

## УДАЛЕННЫЕ требования

### Требование: Запомнить меня
(Устарело в пользу 2FA. Пользователи должны проходить аутентификацию в каждой сессии.)
```

### Разделы дельты

| Раздел | Значение | Что происходит при архивации |
|---------|---------|------------------------|
| `## ДОБАВЛЕННЫЕ требования` | Новое поведение | Дописывается в основную спецификацию |
| `## ИЗМЕНЕННЫЕ требования` | Измененное поведение | Заменяет существующее требование |
| `## УДАЛЕННЫЕ требования` | Устаревшее поведение | Удаляется из основной спецификации |

### Почему дельты, а не полные спецификации

**Ясность.** Дельта показывает именно то, что меняется. Читая полную спецификацию, вам пришлось бы мысленно сравнивать её с текущей версией.

**Избежание конфликтов.** Два изменения могут затрагивать один и тот же файл спецификации без конфликтов, если они изменяют разные требования.

**Эффективность обзора.** Рецензенты видят само изменение, а не неизменный контекст. Внимание фокусируется на главном.

**Соответствие brownfield.** Большинство работ модифицирует существующее поведение. Дельты делают модификации первоклассными элементами процесса.

## Схемы (Schemas)

Схемы определяют типы артефактов и их зависимости для рабочего процесса.

### Как работают схемы

```yaml
# openspec/schemas/spec-driven/schema.yaml
name: spec-driven
artifacts:
  - id: proposal
    generates: proposal.md
    requires: []              # Нет зависимостей, можно создавать первым

  - id: specs
    generates: specs/**/*.md
    requires: [proposal]      # Требуется предложение перед созданием

  - id: design
    generates: design.md
    requires: [proposal]      # Можно создавать параллельно со спецификациями

  - id: tasks
    generates: tasks.md
    requires: [specs, design] # Требуются и спецификации, и дизайн
```

**Артефакты образуют граф зависимостей:**

```
                    предложение
                  (корневой узел)
                       │
         ┌─────────────┴─────────────┐
         │                           │
         ▼                           ▼
  спецификации                    дизайн
   (требует:                   (требует:
   предложение)                 предложение)
         │                           │
         └─────────────┬─────────────┘
                       │
                       ▼
                    задачи
                (требует:
                спецификации, дизайн)
```

**Зависимости — это возможности, а не шлюзы.** Они показывают, что можно создать, а не то, что вы обязаны создать следующим. Вы можете пропустить дизайн, если он вам не нужен. Вы можете создавать спецификации до или после дизайна — оба зависят только от предложения.

### Встроенные схемы

**spec-driven** (по умолчанию)

Стандартный рабочий процесс для разработки, ориентированной на спецификации:

```
предложение → спецификации → дизайн → задачи → реализация
```

Лучше всего подходит для: большинства задач по разработке фич, где вы хотите согласовать спецификации перед реализацией.

### Пользовательские схемы

Создавайте кастомные схемы для рабочего процесса вашей команды:

```bash
# Создать с нуля
openspec schema init research-first

# Или форкнуть существующую
openspec schema fork spec-driven research-first
```

**Пример кастомной схемы:**

```yaml
# openspec/schemas/research-first/schema.yaml
name: research-first
artifacts:
  - id: research
    generates: research.md
    requires: []           # Сначала проводим исследование

  - id: proposal
    generates: proposal.md
    requires: [research]   # Предложение основывается на исследовании

  - id: tasks
    generates: tasks.md
    requires: [proposal]   # Пропускаем спецификации/дизайн, переходим к задачам
```

Полную информацию о создании и использовании кастомных схем см. в разделе [Кастомизация](customization.md).

## Архив (Archive)

Архивация завершает изменение, объединяя его дельта-спецификации с основными спецификациями и сохраняя изменение для истории.

### Что происходит при архивации

```
До архивации:

openspec/
├── specs/
│   └── auth/
│       └── spec.md ◄────────────────┐
└── changes/                         │
    └── add-2fa/                     │
        ├── proposal.md              │
        ├── design.md                │ слияние
        ├── tasks.md                 │
        └── specs/                   │
            └── auth/                │
                └── spec.md ─────────┘


После архивации:

openspec/
├── specs/
│   └── auth/
│       └── spec.md        # Теперь включает требования 2FA
└── changes/
    └── archive/
        └── 2025-01-24-add-2fa/    # Сохранено для истории
            ├── proposal.md
            ├── design.md
            ├── tasks.md
            └── specs/
                └── auth/
                    └── spec.md
```

### Процесс архивации

1. **Слияние дельт.** Каждый раздел дельта-спецификации (ADDED/MODIFIED/REMOVED) применяется к соответствующей основной спецификации.

2. **Перемещение в архив.** Папка изменения перемещается в `changes/archive/` с префиксом даты для хронологического порядка.

3. **Сохранение контекста.** Все артефакты остаются нетронутыми в архиве. Вы всегда можете оглянуться назад, чтобы понять, почему было сделано то или иное изменение.

### Почему архив важен

**Чистое состояние.** В активных изменениях (`changes/`) отображается только работа, находящаяся в процессе. Завершенная работа убирается с пути.

**Аудит.** Архив сохраняет полный контекст каждого изменения — не только то, что изменилось, но и предложение, объясняющее "почему", дизайн, объясняющий "как", и задачи, показывающие выполненную работу.

**Эволюция спецификаций.** Спецификации растут органично по мере архивации изменений. Каждая архивация вливает свои дельты, выстраивая со временем всеобъемлющую спецификацию системы.

## Как все это работает вместе

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            ПОТОК OPENSPEC                                   │
│                                                                              │
│   ┌────────────────┐                                                         │
│   │  1. НАЧАЛО     │  /opsx:new создает папку изменения                      │
│   │     ИЗМЕНЕНИЯ  │                                                         │
│   └───────┬────────┘                                                         │
│           │                                                                  │
│           ▼                                                                  │
│   ┌────────────────┐                                                         │
│   │  2. СОЗДАНИЕ   │  /opsx:ff или /opsx:continue                             │
│   │     АРТЕФАКТОВ │  Создает предложение → спецификации → дизайн → задачи   │
│   │                │  (на основе зависимостей схемы)                         │
│   └───────┬────────┘                                                         │
│           │                                                                  │
│           ▼                                                                  │
│   ┌────────────────┐                                                         │
│   │  3. РЕАЛИЗАЦИЯ │  /opsx:apply                                            │
│   │     ЗАДАЧ      │  Выполнение задач, отметка выполненных                  │
│   │                │◄──── Обновляйте артефакты по мере обучения              │
│   └───────┬────────┘                                                         │
│           │                                                                  │
│           ▼                                                                  │
│   ┌────────────────┐                                                         │
│   │  4. ПРОВЕРКА   │  /opsx:verify (опционально)                              │
│   │     РАБОТЫ     │  Проверка соответствия реализации спецификациям         │
│   └───────┬────────┘                                                         │
│           │                                                                  │
│           ▼                                                                  │
│   ┌────────────────┐     ┌──────────────────────────────────────────────┐   │
│   │  5. АРХИВАЦИЯ  │────►│  Дельта-спецификации вливаются в основные     │   │
│   │     ИЗМЕНЕНИЯ  │     │  Папка изменения перемещается в архив        │   │
│   └────────────────┘     │  Спецификации теперь актуальный источник истины│   │
│                          └──────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Благотворный цикл:**

1. Спецификации описывают текущее поведение.
2. Изменения предлагают модификации (в виде дельт).
3. Реализация воплощает изменения в жизнь.
4. Архивация вливает дельты в спецификации.
5. Спецификации теперь описывают новое поведение.
6. Следующее изменение строится на обновленных спецификациях.

## Глоссарий

| Термин | Определение |
|------|------------|
| **Артефакт (Artifact)** | Документ внутри изменения (предложение, дизайн, задачи или дельта-спецификации) |
| **Архив (Archive)** | Процесс завершения изменения и слияния его дельт с основными спецификациями |
| **Изменение (Change)** | Предлагаемая модификация системы, упакованная в папку с артефактами |
| **Дельта-спецификация (Delta spec)** | Спецификация, описывающая изменения (ADDED/MODIFIED/REMOVED) относительно текущих спецификаций |
| **Домен (Domain)** | Логическая группировка спецификаций (например, `auth/`, `payments/`) |
| **Требование (Requirement)** | Конкретное поведение, которым должна обладать система |
| **Сценарий (Scenario)** | Конкретный пример требования, обычно в формате Дано/Когда/Тогда |
| **Схема (Schema)** | Определение типов артефактов и их зависимостей |
| **Спецификация (Spec)** | Документ, описывающий поведение системы, содержащий требования и сценарии |
| **Источник истины (Source of truth)** | Директория `openspec/specs/`, содержащая текущее согласованное поведение системы |

## Следующие шаги

- [Начало работы](getting-started.md) — практические первые шаги
- [Процессы](workflows.md) — распространенные паттерны и случаи использования
- [Команды](commands.md) — полный справочник команд
- [Кастомизация](customization.md) — создание кастомных схем и настройка проекта
