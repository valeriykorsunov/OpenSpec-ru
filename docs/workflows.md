# Процессы (Workflows)

В данном руководстве рассматриваются распространенные паттерны рабочих процессов для OpenSpec и случаи использования каждого из них. Для базовой настройки см. раздел [Начало работы](getting-started.md). Для ознакомления с командами см. [Команды](commands.md).

## Философия: Действия, а не фазы

Традиционные рабочие процессы заставляют вас проходить через фазы: планирование, затем реализация, затем завершение. Но реальная работа редко укладывается в такие жесткие рамки.

OPSX использует другой подход:

```text
Традиционный (фиксированные фазы):

  ПЛАНИРОВАНИЕ ────────► РЕАЛИЗАЦИЯ ────────► ГОТОВО
      │                    │
      │   "Нельзя назад"   │
      └────────────────────┘

OPSX (гибкие действия):

  предложение ──► спецификации ──► дизайн ──► задачи ──► реализация
```

**Ключевые принципы:**

- **Действия, а не фазы** — Команды — это то, что вы можете делать в любой момент, а не стадии, в которых вы застряли.
- **Зависимости — это возможности** — Они показывают, что можно сделать, а не то, что обязательно должно быть следующим.

> **Кастомизация:** Рабочие процессы OPSX управляются схемами, которые определяют последовательность артефактов. Подробности создания пользовательских схем см. в разделе [Кастомизация](customization.md).

## Паттерны рабочих процессов

### Быстрая фича (Quick Feature)

Когда вы точно знаете, что хотите создать, и вам просто нужно это выполнить:

```text
/opsx:new ──► /opsx:ff ──► /opsx:apply ──► /opsx:verify ──► /opsx:archive
```

**Пример диалога:**

```text
Вы: /opsx:new add-logout-button

ИИ: Создана папка openspec/changes/add-logout-button/
    Готов к созданию: предложение (proposal)

Вы: /opsx:ff

ИИ: Создаю все артефакты планирования...
    ✓ proposal.md
    ✓ specs/
    ✓ design.md
    ✓ tasks.md
    Готов к реализации!

Вы: /opsx:apply

ИИ: Выполняю задачи...
    ✓ Добавлена кнопка выхода в шапку
    ✓ Реализована очистка сессии
    ✓ Добавлено диалоговое окно подтверждения
    Все задачи выполнены!

Вы: /opsx:archive

ИИ: ✓ Спецификации объединены
    ✓ Изменение архивировано
```

**Лучше всего подходит для:** небольших и средних фич, исправления багов, простых изменений.

### Исследовательский процесс (Exploratory)

Когда требования неясны или вам нужно сначала провести исследование:

```text
/opsx:explore ──► /opsx:new ──► /opsx:continue ──► ... ──► /opsx:apply
```

**Пример диалога:**

```text
Вы: /opsx:explore

ИИ: Что бы вы хотели исследовать?

Вы: Я хочу улучшить производительность загрузки страницы, но не уверен, 
    где именно находятся узкие места.

ИИ: Позвольте мне провести исследование...
    [Анализирует размеры бандлов, выявляет медленные запросы, изучает 
    паттерны рендеринга компонентов]

    Я нашел три основных узких места:
    1. Большие неоптимизированные изображения
    2. Синхронная загрузка данных в ProductList
    3. Повторные рендеринги из-за изменений контекста

    С чего бы вы хотели начать?

Вы: Давайте займемся проблемой загрузки данных.

Вы: /opsx:new optimize-product-list-fetching

ИИ: Изменение создано. Готов к созданию: предложение (proposal)

Вы: /opsx:continue

ИИ: Создаю предложение на основе нашего исследования...
    [Пишет предложение, включая результаты исследования]

    Готов к созданию: спецификации (specs), дизайн (design)
    Что создадим следующим?

Вы: /opsx:continue

ИИ: Создаю спецификации...
```

**Лучше всего подходит для:** оптимизации производительности, отладки, архитектурных решений, неясных требований.

### Параллельные изменения

Работа над несколькими изменениями одновременно:

```text
Изменение А: /opsx:new ──► /opsx:ff ──► /opsx:apply (в процессе)
                                         │
                               переключение контекста
                                         │
Изменение Б: /opsx:new ──► /opsx:ff ──────► /opsx:apply
```

**Пример диалога:**

```text
Вы: Я работаю над add-dark-mode, но мне нужно срочно исправить баг

Вы: /opsx:new fix-login-redirect

ИИ: Создана папка openspec/changes/fix-login-redirect/

Вы: /opsx:ff

ИИ: ✓ Артефакты планирования созданы

Вы: /opsx:apply

ИИ: Работаю над fix-login-redirect...
    [Реализует исправление]
    Все задачи выполнены!

Вы: /opsx:archive

ИИ: ✓ Изменение fix-login-redirect архивировано

Вы: Давай вернемся к темной теме

Вы: /opsx:apply add-dark-mode

ИИ: Возобновляю работу над add-dark-mode...
    Продолжаем с задачи 2.3: Обновить Header...
```

**Лучше всего подходит для:** параллельных потоков работы, срочных задач, командного взаимодействия.

Если у вас есть несколько завершенных изменений, используйте `/opsx:bulk-archive`:

```text
Вы: /opsx:bulk-archive

ИИ: Найдено 3 завершенных изменения:
    - add-dark-mode (все задачи выполнены)
    - fix-login-redirect (все задачи выполнены)
    - update-footer (все задачи выполнены)

    Проверка конфликтов спецификаций...
    ⚠ add-dark-mode и update-footer оба затрагивают specs/ui/

    Анализ кодовой базы для разрешения...
    Оба изменения реализованы. Будут применены в хронологическом порядке.

    Архивировать все 3 изменения?

Вы: Да

ИИ: ✓ Изменение add-dark-mode архивировано
    ✓ Изменение fix-login-redirect архивировано
    ✓ Изменение update-footer архивировано
    Спецификации объединены в порядке: add-dark-mode → update-footer
```

Массовое архивирование определяет, когда несколько изменений затрагивают одни и те же спецификации, и разрешает конфликты, проверяя, что фактически реализовано.

### Завершение изменения

Рекомендуемый процесс завершения:

```text
/opsx:apply ──► /opsx:verify ──► /opsx:archive
                    │                 │
              проверяет          предлагает синхронизацию
              реализацию         при необходимости
```

#### Verify: Проверка работы

`/opsx:verify` проверяет реализацию на соответствие вашим артефактам по трем измерениям:

```text
Вы: /opsx:verify

ИИ: Проверка add-auth...

     ПОЛНОТА (COMPLETENESS)
     ✓ Все 12 задач в tasks.md отмечены
     ✓ Все требования в спецификациях имеют соответствующий код
     ⚠ Сценарий "Тайм-аут сессии после бездействия" не протестирован

     КОРРЕКТНОСТЬ (CORRECTNESS)
     ✓ Реализация соответствует намерениям в спецификации
     ✓ Граничные случаи из сценариев обработаны
     ✓ Состояния ошибок соответствуют определениям в спецификации

     СОГЛАСОВАННОСТЬ (COHERENCE)
     ✓ Архитектурные решения отражены в структуре кода
     ✓ Соглашения о именовании соответствуют design.md
     ⚠ В дизайне упоминается "событийно-ориентированный" подход, но в реализации используется опрос (polling)

     ИТОГ
     ─────────────────────────────
     Критические проблемы: 0
     Предупреждения: 2
     Готов к архивации: Да (с предупреждениями)

     Рекомендации:
     1. Добавить тест для сценария тайм-аута сессии
     2. Рассмотреть возможность рефакторинга на событийно-ориентированный подход, как было задумано, либо обновить design.md
```

**Что проверяет verify:**

| Измерение | Что проверяется |
|-----------|------------------|
| Полнота | Все задачи выполнены, все требования реализованы, сценарии покрыты |
| Корректность | Реализация соответствует спецификации, граничные случаи обработаны |
| Согласованность | Дизайнерские решения отражены в коде, паттерны последовательны |

Verify не блокирует архивацию, но выявляет проблемы, которые стоит устранить перед завершением.

#### Archive: Финализация изменения

`/opsx:archive` завершает работу над изменением и перемещает его в архив:

```text
Вы: /opsx:archive

ИИ: Архивирую add-auth...

     Статус артефактов:
     ✓ proposal.md существует
     ✓ specs/ существует
     ✓ design.md существует
     ✓ tasks.md существует (выполнено 12 из 12 задач)

     Дельта-спецификации: еще не синхронизированы с основной веткой
     → Хотите синхронизировать сейчас?

Вы: Да

ИИ: ✓ Спецификации синхронизированы в openspec/specs/auth/spec.md
    ✓ Изменение перемещено в openspec/changes/archive/2025-01-24-add-auth/

    Изменение успешно архивировано.
```

Archive предложит синхронизацию, если спецификации еще не обновлены. Команда не заблокирует процесс при невыполненных задачах, но выдаст предупреждение.

## Когда и что использовать

### `/opsx:ff` против `/opsx:continue`

| Ситуация | Используйте |
|-----------|-----|
| Четкие требования, готовы к сборке | `/opsx:ff` |
| Исследование, хотите проверять каждый шаг | `/opsx:continue` |
| Хотите доработать предложение перед спецификациями | `/opsx:continue` |
| Ограничение по времени, нужно действовать быстро | `/opsx:ff` |
| Сложное изменение, нужен полный контроль | `/opsx:continue` |

**Золотое правило:** Если вы можете описать весь объем работы сразу — используйте `/opsx:ff`. Если вы разбираетесь в процессе — используйте `/opsx:continue`.

### Обновить существующее или начать новое?

Частый вопрос: когда допустимо обновлять существующее изменение, а когда следует начинать новое?

**Обновляйте существующее изменение, если:**

- То же намерение, уточненное исполнение.
- Объем сужается (сначала MVP, остальное позже).
- Исправления на основе изученного (кодовая база оказалась не такой, как ожидалось).
- Корректировки дизайна на основе открытий в процессе реализации.

**Начинайте новое изменение, если:**

- Намерение принципиально изменилось.
- Объем разросся до совершенно другой задачи.
- Оригинальное изменение может быть помечено как "готово" само по себе.
- Доработки скорее запутают, чем прояснят ситуацию.

```text
                     ┌─────────────────────────────────────┐
                     │     Это та же самая работа?         │
                     └──────────────┬──────────────────────┘
                                    │
                 ┌──────────────────┼──────────────────┐
                 │                  │                  │
                 ▼                  ▼                  ▼
          То же намерение?   Перекрытие >50%?    Можно ли считать
          Та же проблема?    Тот же объем?       оригинал "готовым"
                 │                  │            без этих правок?
                 │                  │                  │
       ┌────────┴────────┐  ┌──────┴──────┐   ┌───────┴───────┐
       │                 │  │             │   │               │
       ДА               НЕТ ДА           НЕТ НЕТ              ДА
       │                 │  │             │   │               │
       ▼                 ▼  ▼             ▼   ▼               ▼
    ОБНОВИТЬ          НОВОЕ ОБНОВИТЬ       НОВОЕ ОБНОВИТЬ      НОВОЕ
```

**Пример: "Добавить темную тему"**

- "Нужно также поддерживать пользовательские темы" → Новое изменение (объем разросся).
- "Определение системных настроек оказалось сложнее, чем ожидалось" → Обновить (намерение то же).
- "Давайте сначала выпустим переключатель, а настройки добавим позже" → Обновить, затем архивировать, затем новое изменение.

## Лучшие практики

### Фокусируйтесь на одном изменении

Одна логическая единица работы на одно изменение. Если вы делаете "добавить фичу X и также отрефакторить Y", рассмотрите возможность создания двух отдельных изменений.

**Почему это важно:**
- Проще рецензировать и понимать.
- Чистая история архива.
- Можно выпускать независимо.
- Проще откатить при необходимости.

### Используйте `/opsx:explore` для неясных требований

Прежде чем приступать к изменению, изучите проблему:

```text
Вы: /opsx:explore

ИИ: Что бы вы хотели исследовать?

Вы: Как нам реализовать ограничение частоты запросов (rate limiting) для нашего API?

ИИ: Позвольте мне изучить вашу текущую настройку и варианты...
    [Изучает кодовую базу, рассматривает паттерны]

    Я вижу три подхода, которые мы могли бы использовать:
    1. На основе middleware (просто, для каждого эндпоинта)
    2. С использованием Redis (масштабируемо, общее состояние)
    3. Token bucket для каждого пользователя (справедливо, сложно)

    Ваш текущий стек предполагает варианты №1 или №2. Каков ваш масштаб?
```

Исследование проясняет мысли до того, как вы начнете создавать артефакты.

### Проверяйте перед архивацией

Используйте `/opsx:verify`, чтобы убедиться, что реализация соответствует артефактам:

```text
Вы: /opsx:verify

ИИ: Проверка add-dark-mode...

     ✓ Все задачи в tasks.md отмечены
     ✓ Требования в спецификациях имеют соответствующий код
     ✓ Дизайнерские решения отражены в реализации

     Готов к архивации!
```

Это позволяет выявить несоответствия до того, как вы закроете задачу.

### Называйте изменения четко

Хорошие названия делают `openspec list` полезным:

```text
Хорошо:                        Избегайте:
add-dark-mode                  feature-1
fix-login-redirect             update
optimize-product-query         changes
implement-2fa                  wip
```

## Краткий справочник команд

Полную информацию о командах и опциях см. в разделе [Команды](commands.md).

| Команда | Цель | Когда использовать |
|---------|---------|-------------|
| `/opsx:explore` | Продумывание идей | Неясные требования, исследование |
| `/opsx:new` | Начать изменение | В начале любой новой работы |
| `/opsx:continue` | Создать следующий артефакт | Пошаговое создание артефактов |
| `/opsx:ff` | Создать все артефакты планирования | Четкий объем, готовность к сборке |
| `/opsx:apply` | Выполнить задачи | Готовность к написанию кода |
| `/opsx:verify` | Проверить реализацию | Перед архивацией, для поиска несоответствий |
| `/opsx:sync` | Синхронизировать дельта-спецификации | Опционально — archive предложит сама |
| `/opsx:archive` | Завершить изменение | Вся работа закончена |
| `/opsx:bulk-archive` | Архивировать несколько изменений | Параллельная работа, массовое завершение |

## Следующие шаги

- [Команды](commands.md) — Полный справочник команд с опциями
- [Концепции](concepts.md) — Глубокое погружение в спецификации, артефакты и схемы
- [Кастомизация](customization.md) — Создание собственных рабочих процессов
