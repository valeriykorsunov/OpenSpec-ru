# Кастомизация (Customization)

OpenSpec предоставляет три уровня кастомизации:

| Уровень | Что делает | Для кого |
|-------|--------------|----------|
| **Конфигурация проекта** | Установка значений по умолчанию, внедрение контекста/правил | Большинство команд |
| **Пользовательские схемы** | Определение собственных артефактов рабочего процесса | Команды с уникальными процессами |
| **Глобальные переопределения** | Обмен схемами между всеми проектами | Продвинутые пользователи |

---

## Конфигурация проекта

Файл `openspec/config.yaml` — самый простой способ адаптировать OpenSpec под нужды вашей команды. Он позволяет:

- **Установить схему по умолчанию** — чтобы не указывать `--schema` в каждой команде.
- **Внедрить контекст проекта** — ИИ будет видеть ваш техстек, соглашения и т.д.
- **Добавить правила для артефактов** — специфические правила для каждого типа артефакта.

### Быстрая настройка

```bash
openspec init
```

Эта команда проведет вас через процесс создания конфигурации в интерактивном режиме. Или вы можете создать файл вручную:

```yaml
# openspec/config.yaml
schema: spec-driven

context: |
  Технологический стек: TypeScript, React, Node.js, PostgreSQL
  Стиль API: RESTful, документирован в docs/api.md
  Тестирование: Jest + React Testing Library
  Мы ценим обратную совместимость для всех публичных API

rules:
  proposal:
    - Включать план отката
    - Указывать затронутые команды
  specs:
    - Использовать формат Given/When/Then
    - Ссылаться на существующие паттерны перед созданием новых
```

### Как это работает

**Схема по умолчанию:**

```bash
# Без конфигурации
openspec new change my-feature --schema spec-driven

# С конфигурацией — схема применяется автоматически
openspec new change my-feature
```

**Внедрение контекста и правил:**

При создании любого артефакта ваш контекст и правила внедряются в промпт ИИ:

```xml
<context>
Технологический стек: TypeScript, React, Node.js, PostgreSQL
...
</context>

<rules>
- Включать план отката
- Указывать затронутые команды
</rules>

<template>
[Встроенный шаблон схемы]
</template>
```

- **Контекст (Context)** появляется во ВСЕХ артефактах.
- **Правила (Rules)** появляются ТОЛЬКО в соответствующих артефактах.

### Порядок разрешения схем

Когда OpenSpec требуется схема, она ищется в следующем порядке:

1. Флаг CLI: `--schema <имя>`
2. Метаданные изменения (`.openspec.yaml` в папке изменения)
3. Конфигурация проекта (`openspec/config.yaml`)
4. По умолчанию (`spec-driven`)

---

## Пользовательские схемы

Если конфигурации проекта недостаточно, вы можете создать собственную схему с полностью кастомным рабочим процессом. Пользовательские схемы хранятся в директории `openspec/schemas/` вашего проекта и находятся под контролем версий вместе с кодом.

```text
your-project/
├── openspec/
│   ├── config.yaml        # Конфигурация проекта
│   ├── schemas/           # Здесь живут пользовательские схемы
│   │   └── my-workflow/
│   │       ├── schema.yaml
│   │       └── templates/
│   └── changes/           # Ваши изменения
└── src/
```

### Форк существующей схемы

Самый быстрый способ создать свою схему — это форкнуть одну из встроенных:

```bash
openspec schema fork spec-driven my-workflow
```

Это скопирует всю схему `spec-driven` в `openspec/schemas/my-workflow/`, где вы сможете свободно её редактировать.

**Что вы получите:**

```text
openspec/schemas/my-workflow/
├── schema.yaml           # Определение рабочего процесса
└── templates/
    ├── proposal.md       # Шаблон для артефакта "предложение"
    ├── spec.md           # Шаблон для спецификаций
    ├── design.md         # Шаблон для дизайна
    └── tasks.md          # Шаблон для задач
```

Теперь отредактируйте `schema.yaml`, чтобы изменить процесс, или шаблоны в папке `templates/`, чтобы изменить генерируемый ИИ контент.

### Создание схемы с нуля

Для создания совершенно нового рабочего процесса:

```bash
# Интерактивный режим
openspec schema init research-first

# Неинтерактивный режим
openspec schema init rapid \
  --description "Рабочий процесс для быстрых итераций" \
  --artifacts "proposal,tasks" \
  --default
```

### Структура схемы

Схема определяет артефакты вашего процесса и их взаимозависимости:

```yaml
# openspec/schemas/my-workflow/schema.yaml
name: my-workflow
version: 1
description: Кастомный рабочий процесс моей команды

artifacts:
  - id: proposal
    generates: proposal.md
    description: Начальный документ предложения
    template: proposal.md
    instruction: |
      Создайте предложение, объясняющее, ПОЧЕМУ нужно это изменение.
      Сосредоточьтесь на проблеме, а не на решении.
    requires: []

  - id: design
    generates: design.md
    description: Технический проект
    template: design.md
    instruction: |
      Создайте документ дизайна, объясняющий, КАК реализовать задачу.
    requires:
      - proposal    # Нельзя создать дизайн без предложения

  - id: tasks
    generates: tasks.md
    description: Список задач на реализацию
    template: tasks.md
    requires:
      - design

apply:
  requires: [tasks]
  tracks: tasks.md
```

**Ключевые поля:**

| Поле | Назначение |
|-------|---------|
| `id` | Уникальный идентификатор, используемый в командах и правилах |
| `generates` | Имя выходного файла (поддерживает glob-паттерны, например `specs/**/*.md`) |
| `template` | Файл шаблона в директории `templates/` |
| `instruction` | Инструкции для ИИ по созданию этого артефакта |
| `requires` | Зависимости — какие артефакты должны существовать первыми |

### Шаблоны

Шаблоны — это markdown-файлы, которые направляют ИИ. Они внедряются в промпт при создании артефакта.

```markdown
<!-- templates/proposal.md -->
## Почему

<!-- Объясните мотивацию этого изменения. Какую проблему оно решает? -->

## Что меняется

<!-- Опишите, что именно изменится. Укажите новые возможности или модификации. -->

## Влияние

<!-- Затронутый код, API, зависимости, системы -->
```

Шаблоны могут включать:
- Заголовки разделов, которые ИИ должен заполнить.
- HTML-комментарии с подсказками для ИИ.
- Примеры форматов, показывающие ожидаемую структуру.

### Валидация схемы

Перед использованием пользовательской схемы проверьте её на ошибки:

```bash
openspec schema validate my-workflow
```

Это проверит:
- Правильность синтаксиса `schema.yaml`.
- Существование всех указанных шаблонов.
- Отсутствие циклических зависимостей.
- Валидность ID артефактов.

### Использование пользовательской схемы

После создания используйте вашу схему следующими способами:

```bash
# Укажите в команде
openspec new change feature --schema my-workflow

# Или установите как значение по умолчанию в config.yaml
schema: my-workflow
```

### Отладка разрешения схем

Не уверены, какая схема используется? Проверьте командой:

```bash
# Узнать путь к конкретной схеме
openspec schema which my-workflow

# Список всех доступных схем
openspec schema which --all
```

Вывод покажет, откуда взята схема: из проекта, из директории пользователя или из пакета:

```text
Schema: my-workflow
Source: project
Path: /path/to/project/openspec/schemas/my-workflow
```

---

> **Примечание:** OpenSpec также поддерживает схемы на уровне пользователя в `~/.local/share/openspec/schemas/` для совместного использования в разных проектах, но рекомендуются схемы уровня проекта в `openspec/schemas/`, так как они версионируются вместе с вашим кодом.

---

## Примеры

### Рабочий процесс для быстрых итераций (Rapid)

Минималистичный процесс для быстрых правок:

```yaml
# openspec/schemas/rapid/schema.yaml
name: rapid
version: 1
description: Быстрые итерации с минимальными затратами

artifacts:
  - id: proposal
    generates: proposal.md
    description: Краткое предложение
    template: proposal.md
    instruction: |
      Создайте краткое предложение для этого изменения.
      Сосредоточьтесь на том, "что" и "почему", пропустите подробные спецификации.
    requires: []

  - id: tasks
    generates: tasks.md
    description: Список задач на реализацию
    template: tasks.md
    requires: [proposal]

apply:
  requires: [tasks]
  tracks: tasks.md
```

### Добавление артефакта "Обзор" (Review)

Форкните схему по умолчанию и добавьте этап обзора:

```bash
openspec schema fork spec-driven with-review
```

Затем отредактируйте `schema.yaml`, добавив:

```yaml
  - id: review
    generates: review.md
    description: Чек-лист проверки перед реализацией
    template: review.md
    instruction: |
      Создайте чек-лист проверки на основе дизайна.
      Включите вопросы безопасности, производительности и тестирования.
    requires:
      - design

  - id: tasks
    # ... существующая конфигурация задач ...
    requires:
      - specs
      - design
      - review    # Теперь задачи требуют прохождения этапа review
```

---

## См. также

- [Справочник CLI: Команды схем](cli.md#schema-commands) — полная документация по командам
