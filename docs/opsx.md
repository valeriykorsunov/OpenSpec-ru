# Рабочий процесс OPSX

> Приветствуются отзывы в [Discord](https://discord.gg/YctCnvvshC).

## Что это?

OPSX теперь является стандартным рабочим процессом для OpenSpec.

Это **гибкий, итеративный рабочий процесс** для изменений в OpenSpec. Больше никаких жестких фаз — только действия, которые вы можете выполнять в любое время.

## Зачем это нужно

Устаревший рабочий процесс OpenSpec работает, но он **замкнут**:

- **Инструкции жестко закодированы** — спрятаны в TypeScript, вы не можете их изменить
- **Все или ничего** — одна большая команда создает все сразу, нельзя протестировать отдельные части
- **Фиксированная структура** — одинаковый рабочий процесс для всех, никакой настройки
- **Черный ящик** — когда ИИ выдает плохой результат, вы не можете подправить промпты

**OPSX открывает возможности.** Теперь любой может:

1. **Экспериментировать с инструкциями** — отредактировать шаблон, проверить, справится ли ИИ лучше
2. **Тестировать гранулярно** — проверять инструкции для каждого артефакта независимо
3. **Настраивать рабочие процессы** — определять свои собственные артефакты и зависимости
4. **Быстро итерировать** — изменить шаблон, протестировать немедленно, без пересборки

```
Устаревший процесс:                   OPSX:
┌────────────────────────┐           ┌────────────────────────┐
│  Зашито в пакете       │           │  schema.yaml           │◄── Вы редактируете это
│  (нельзя изменить)     │           │  templates/*.md        │◄── Или это
│        ↓               │           │        ↓               │
│  Ждать нового релиза   │           │  Мгновенный эффект     │
│        ↓               │           │        ↓               │
│  Надеяться на лучшее   │           │  Проверить самому      │
└────────────────────────┘           └────────────────────────┘
```

**Это для всех:**
- **Команды** — создавайте рабочие процессы, соответствующие тому, как вы реально работаете
- **Продвинутые пользователи** — настраивайте промпты для получения лучших результатов ИИ для вашей кодовой базы
- **Контрибьюторы OpenSpec** — экспериментируйте с новыми подходами без необходимости релизов

Мы все еще учимся тому, что работает лучше всего. OPSX позволяет нам учиться вместе.

## Пользовательский опыт

**Проблема линейных рабочих процессов:**
Вы находитесь "в фазе планирования", затем "в фазе реализации", затем "готово". Но реальная работа так не строится. Вы что-то реализуете, понимаете, что дизайн был неправильным, нужно обновить спецификации, продолжить реализацию. Линейные фазы противоречат тому, как на самом деле происходит работа.

**Подход OPSX:**
- **Действия, а не фазы** — создавайте, реализуйте, обновляйте, архивируйте — делайте что угодно в любое время
- **Зависимости как инструменты** — они показывают, что возможно, а не что требуется следующим

```
  предложение ──→ спецификации ──→ дизайн ──→ задачи ──→ реализация
```

## Настройка

```bash
# Убедитесь, что у вас установлен openspec — навыки генерируются автоматически
openspec init
```

Это создает навыки в `.claude/skills/` (или эквиваленте), которые автоматически обнаруживаются ИИ-ассистентами по коду.

Во время настройки вам будет предложено создать **конфигурацию проекта** (`openspec/config.yaml`). Это необязательно, но рекомендуется.

## Конфигурация проекта

Конфигурация проекта позволяет задавать значения по умолчанию и внедрять контекст, специфичный для проекта, во все артефакты.

### Создание конфигурации

Конфигурация создается во время `openspec init` или вручную:

```yaml
# openspec/config.yaml
schema: spec-driven

context: |
  Tech stack: TypeScript, React, Node.js
  API conventions: RESTful, JSON responses
  Testing: Vitest for unit tests, Playwright for e2e
  Style: ESLint with Prettier, strict TypeScript

rules:
  proposal:
    - Include rollback plan
    - Identify affected teams
  specs:
    - Use Given/When/Then format for scenarios
  design:
    - Include sequence diagrams for complex flows
```

### Поля конфигурации

| Поле | Тип | Описание |
|-------|------|-------------|
| `schema` | string | Схема по умолчанию для новых изменений (например, `spec-driven`) |
| `context` | string | Контекст проекта, внедряемый во все инструкции артефактов |
| `rules` | object | Правила для каждого артефакта, по ID артефакта |

### Как это работает

**Приоритет схем** (от высшего к низшему):
1. Флаг CLI (`--schema <name>`)
2. Метаданные изменения (`.openspec.yaml` в директории изменения)
3. Конфигурация проекта (`openspec/config.yaml`)
4. По умолчанию (`spec-driven`)

**Внедрение контекста:**
- Контекст добавляется в начало инструкций каждого артефакта
- Обернут в теги `<context>...</context>`
- Помогает ИИ понять конвенции вашего проекта

**Внедрение правил:**
- Правила внедряются только для соответствующих артефактов
- Обернуты в теги `<rules>...</rules>`
- Появляются после контекста, перед шаблоном

### ID артефактов по схемам

**spec-driven** (по умолчанию):
- `proposal` — Предложение изменения
- `specs` — Спецификации
- `design` — Технический дизайн
- `tasks` — Задачи реализации

### Валидация конфигурации

- Неизвестные ID артефактов в `rules` вызывают предупреждения
- Имена схем проверяются на наличие доступных схем
- Контекст имеет лимит размера 50KB
- Невалидный YAML сообщается с номерами строк

### Устранение неполадок

**"Unknown artifact ID in rules: X"**
- Проверьте, что ID артефактов соответствуют вашей схеме (см. список выше)
- Запустите `openspec schemas --json`, чтобы увидеть ID артефактов для каждой схемы

**Конфигурация не применяется:**
- Убедитесь, что файл находится по пути `openspec/config.yaml` (не `.yml`)
- Проверьте синтаксис YAML валидатором
- Изменения конфигурации вступают в силу немедленно (перезапуск не требуется)

**Контекст слишком большой:**
- Контекст ограничен 50KB
- Сократите или дайте ссылку на внешнюю документацию

## Команды

| Команда | Что делает |
|---------|------------|
| `/opsx:explore` | Обдумать идеи, исследовать проблемы, уточнить требования |
| `/opsx:new` | Начать новое изменение |
| `/opsx:continue` | Создать следующий артефакт (на основе того, что готово) |
| `/opsx:ff` | Перемотка вперед — создать все артефакты планирования сразу |
| `/opsx:apply` | Реализовать задачи, обновляя артефакты по мере необходимости |
| `/opsx:sync` | Синхронизировать дельта-спецификации с основными (опционально — архивировать промпты при необходимости) |
| `/opsx:archive` | Архивировать после завершения |

## Использование

### Исследовать идею
```
/opsx:explore
```
Обдумайте идеи, исследуйте проблемы, сравните варианты. Структура не требуется — просто партнер для размышлений. Когда идеи кристаллизуются, переходите к `/opsx:new` или `/opsx:ff`.

### Начать новое изменение
```
/opsx:new
```
Вас спросят, что вы хотите создать и какую схему рабочего процесса использовать.

### Создать артефакты
```
/opsx:continue
```
Показывает, что готово к созданию на основе зависимостей, затем создает один артефакт. Используйте многократно для постепенного построения вашего изменения.

```
/opsx:ff add-dark-mode
```
Создает все артефакты планирования сразу. Используйте, когда у вас есть четкое представление о том, что вы строите.

### Реализовать (гибкая часть)
```
/opsx:apply
```
Проходит по задачам, отмечая их по мере выполнения. Если вы ведете несколько изменений, можно запустить `/opsx:apply <name>`; иначе он должен понять из разговора и предложить выбрать, если не сможет определить.

### Завершить
```
/opsx:archive   # Переместить в архив по завершении (предлагает синхронизировать спецификации при необходимости)
```

## Когда обновлять, а когда начинать заново

Вы всегда можете отредактировать предложение или спецификации перед реализацией. Но когда уточнение становится "это уже другая работа"?

### Что фиксирует Предложение

Предложение определяет три вещи:
1. **Намерение** — Какую проблему вы решаете?
2. **Объем** — Что входит/не входит в рамки?
3. **Подход** — Как вы будете это решать?

Вопрос в том: что изменилось и насколько сильно?

### Обновляйте существующее изменение, когда:

**То же намерение, уточненное исполнение**
- Вы обнаружили крайние случаи, которые не учли
- Подход требует доработки, но цель не изменилась
- Реализация показала, что дизайн был немного неточным

**Объем сужается**
- Вы поняли, что полный объем слишком велик, хотите сначала выпустить MVP
- "Добавить темную тему" → "Добавить переключатель темной темы (системная настройка в v2)"

**Корректировки на основе обучения**
- Кодовая база структурирована не так, как вы думали
- Зависимость работает не так, как ожидалось
- "Использовать CSS переменные" → "Использовать префикс dark: из Tailwind"

### Начинайте новое изменение, когда:

**Намерение фундаментально изменилось**
- Сама проблема теперь другая
- "Добавить темную тему" → "Добавить комплексную систему тем с кастомными цветами, шрифтами, отступами"

**Объем раздулся**
- Изменение выросло настолько, что это по сути другая работа
- Оригинальное предложение было бы неузнаваемым после обновлений
- "Исправить баг входа" → "Переписать систему авторизации"

**Оригинал можно завершить**
- Оригинальное изменение может быть помечено как "готово"
- Новая работа стоит отдельно, а не является уточнением
- Завершить "Добавить темную тему MVP" → Архив → Новое изменение "Улучшить темную тему"

### Эвристика

```
                        ┌─────────────────────────────────────┐
                        │       Это та же работа?             │
                        └──────────────┬──────────────────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
                    ▼                  ▼                  ▼
             То же намерение?  >50% перекрытия?   Может оригинал
             Та же проблема?   Тот же объем?      быть "готов" без
                    │                  │          этих изменений?
                    │                  │                  │
          ┌────────┴────────┐  ┌──────┴──────┐   ┌───────┴───────┐
          │                 │  │             │   │               │
         ДА                НЕТ ДА           НЕТ НЕТ             ДА
          │                 │  │             │   │               │
          ▼                 ▼  ▼             ▼   ▼               ▼
       ОБНОВИТЬ           НОВОЕ ОБНОВИТЬ   НОВОЕ ОБНОВИТЬ      НОВОЕ
```

| Тест | Обновить | Новое изменение |
|------|----------|-----------------|
| **Идентичность** | "То же самое, уточнено" | "Другая работа" |
| **Перекрытие объема** | >50% перекрывается | <50% перекрывается |
| **Завершение** | Не может быть "готово" без изменений | Можно закончить оригинал, новая работа самостоятельна |
| **История** | Цепочка обновлений рассказывает связную историю | Патчи запутают больше, чем прояснят |

### Принцип

> **Обновление сохраняет контекст. Новое изменение дает ясность.**
>
> Выбирайте обновление, когда история вашего мышления ценна.
> Выбирайте новое, когда начать с чистого листа будет понятнее, чем латать.

Думайте об этом как о ветках git:
- Продолжайте коммитить, работая над той же фичей
- Начинайте новую ветку, когда это действительно новая работа
- Иногда сливайте частичную фичу и начинайте заново для фазы 2

## В чем отличия?

| | Legacy (`/openspec:proposal`) | OPSX (`/opsx:*`) |
|---|---|---|
| **Структура** | Один большой документ предложения | Дискретные артефакты с зависимостями |
| **Рабочий процесс** | Линейные фазы: план → реализация → архив | Гибкие действия — делайте что угодно в любое время |
| **Итерация** | Неудобно возвращаться назад | Обновляйте артефакты по мере обучения |
| **Настройка** | Фиксированная структура | Управляемый схемой (определяйте свои артефакты) |

**Ключевой инсайт:** работа не линейна. OPSX перестает притворяться, что это так.

## Глубокое погружение в архитектуру

Этот раздел объясняет, как OPSX работает "под капотом" и как он сравнивается с устаревшим рабочим процессом.

### Философия: Фазы против Действий

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       УСТАРЕВШИЙ ПРОЦЕСС (LEGACY)                           │
│                 (Заблокированные фазы, Все или ничего)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐              │
│   │     ФАЗА     │ ───► │     ФАЗА     │ ───► │     ФАЗА     │              │
│   │ ПЛАНИРОВАНИЯ │      │  РЕАЛИЗАЦИИ  │      │ АРХИВАЦИИ    │              │
│   └──────────────┘      └──────────────┘      └──────────────┘              │
│         │                     │                     │                       │
│         ▼                     ▼                     ▼                       │
│   /openspec:proposal   /openspec:apply      /openspec:archive               │
│                                                                             │
│   • Создает ВСЕ артефакты за один раз                                       │
│   • Нельзя вернуться для обновления спецификаций во время реализации        │
│   • Фазовые шлюзы принуждают к линейному прогрессу                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                            ПРОЦЕСС OPSX                                     │
│                     (Гибкие действия, Итеративный)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│              ┌────────────────────────────────────────────┐                 │
│              │           ДЕЙСТВИЯ (не фазы)               │                 │
│              │                                            │                 │
│              │   new ◄──► continue ◄──► apply ◄──► archive│                 │
│              │    │          │           │           │    │                 │
│              │    └──────────┴───────────┴───────────┘    │                 │
│              │             любой порядок                  │                 │
│              └────────────────────────────────────────────┘                 │
│                                                                             │
│   • Создавайте артефакты по одному ИЛИ перематывайте вперед                 │
│   • Обновляйте спецификации/дизайн/задачи во время реализации               │
│   • Зависимости позволяют прогресс, фаз не существует                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Архитектура компонентов

**Устаревший процесс** использует жестко закодированные шаблоны в TypeScript:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   КОМПОНЕНТЫ УСТАРЕВШЕГО ПРОЦЕССА                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Жестко закодированные шаблоны (строки TypeScript)                         │
│                    │                                                        │
│                    ▼                                                        │
│   Конфигураторы (18+ классов, один на редактор)                             │
│                    │                                                        │
│                    ▼                                                        │
│   Сгенерированные файлы команд (.claude/commands/openspec/*.md)             │
│                                                                             │
│   • Фиксированная структура, нет осведомленности об артефактах              │
│   • Изменение требует модификации кода + пересборки                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**OPSX** использует внешние схемы и движок графа зависимостей:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         КОМПОНЕНТЫ OPSX                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Определения схем (YAML)                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  name: spec-driven                                                  │   │
│   │  artifacts:                                                         │   │
│   │    - id: proposal                                                   │   │
│   │      generates: proposal.md                                         │   │
│   │      requires: []              ◄── Зависимости                      │   │
│   │    - id: specs                                                      │   │
│   │      generates: specs/**/*.md  ◄── Glob паттерны                    │   │
│   │      requires: [proposal]      ◄── Включается после proposal        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                    │                                                        │
│                    ▼                                                        │
│   Движок графа артефактов                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  • Топологическая сортировка (упорядочивание зависимостей)          │   │
│   │  • Обнаружение состояния (существование в файловой системе)         │   │
│   │  • Генерация богатых инструкций (шаблоны + контекст)                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                    │                                                        │
│                    ▼                                                        │
│   Файлы навыков (.claude/skills/openspec-*/SKILL.md)                        │
│                                                                             │
│   • Совместимость между редакторами (Claude Code, Cursor, Windsurf)         │
│   • CLI запросов навыков для структурированных данных                       │
│   • Полная настраиваемость через файлы схем                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Модель графа зависимостей

Артефакты формируют направленный ациклический граф (DAG). Зависимости — это **инструменты**, а не шлюзы:

```
                              proposal
                             (корневой узел)
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
                 specs                       design
              (требует:                   (требует:
               proposal)                   proposal)
                    │                           │
                    └─────────────┬─────────────┘
                                  │
                                  ▼
                               tasks
                           (требует:
                           specs, design)
                                  │
                                  ▼
                          ┌──────────────┐
                          │ ФАЗА ПРИМЕН. │
                          │ (требует:    │
                          │  tasks)      │
                          └──────────────┘
```

**Переходы состояний:**

```
   ЗАБЛОКИРОВАНО ──────────► ГОТОВО ─────────────► ЗАВЕРШЕНО
      │                        │                       │
   Отсутствуют              Все зависимости        Файл существует
   зависимости              ЗАВЕРШЕНЫ              в файловой системе
```

### Поток информации

**Устаревший процесс** — агент получает статические инструкции:

```
  Пользователь: "/openspec:proposal"
           │
           ▼
  ┌─────────────────────────────────────────┐
  │  Статические инструкции:                │
  │  • Создать proposal.md                  │
  │  • Создать tasks.md                     │
  │  • Создать design.md                    │
  │  • Создать specs/<capability>/spec.md   │
  │                                         │
  │  Нет осведомленности о том, что         │
  │  существует, или о зависимостях         │
  └─────────────────────────────────────────┘
           │
           ▼
  Агент создает ВСЕ артефакты за один раз
```

**OPSX** — агент запрашивает богатый контекст:

```
  Пользователь: "/opsx:continue"
           │
           ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │  Шаг 1: Запрос текущего состояния                                        │
  │  ┌────────────────────────────────────────────────────────────────────┐  │
  │  │  $ openspec status --change "add-auth" --json                      │  │
  │  │                                                                    │  │
  │  │  {                                                                 │  │
  │  │    "artifacts": [                                                  │  │
  │  │      {"id": "proposal", "status": "done"},                         │  │
  │  │      {"id": "specs", "status": "ready"},      ◄── Первый готовый   │  │
  │  │      {"id": "design", "status": "ready"},                          │  │
  │  │      {"id": "tasks", "status": "blocked", "missingDeps": ["specs"]}│  │
  │  │    ]                                                               │  │
  │  │  }                                                                 │  │
  │  └────────────────────────────────────────────────────────────────────┘  │
  │                                                                          │
  │  Шаг 2: Получение богатых инструкций для готового артефакта              │
  │  ┌────────────────────────────────────────────────────────────────────┐  │
  │  │  $ openspec instructions specs --change "add-auth" --json          │  │
  │  │                                                                    │  │
  │  │  {                                                                 │  │
  │  │    "template": "# Specification\n\n## ADDED Requirements...",      │  │
  │  │    "dependencies": [{"id": "proposal", "path": "...", "done": true}│  │
  │  │    "unlocks": ["tasks"]                                            │  │
  │  │  }                                                                 │  │
  │  └────────────────────────────────────────────────────────────────────┘  │
  │                                                                          │
  │  Шаг 3: Чтение зависимостей → Создание ОДНОГО артефакта → Показ того,    │
  │         что разблокировано                                               │
  └──────────────────────────────────────────────────────────────────────────┘
```

### Модель итерации

**Устаревший процесс** — неудобно итерировать:

```
  ┌─────────┐     ┌─────────┐     ┌─────────┐
  │/proposal│ ──► │ /apply  │ ──► │/archive │
  └─────────┘     └─────────┘     └─────────┘
       │               │
       │               ├── "Погодите, дизайн неправильный"
       │               │
       │               ├── Опции:
       │               │   • Редактировать файлы вручную (ломает контекст)
       │               │   • Бросить и начать заново
       │               │   • Пробиться и исправить позже
       │               │
       │               └── Нет официального механизма "назад"
       │
       └── Создает ВСЕ артефакты за один раз
```

**OPSX** — естественная итерация:

```
  /opsx:new ───► /opsx:continue ───► /opsx:apply ───► /opsx:archive
      │                │                  │
      │                │                  ├── "Дизайн неправильный"
      │                │                  │
      │                │                  ▼
      │                │            Просто отредактируйте design.md
      │                │            и продолжайте!
      │                │                  │
      │                │                  ▼
      │                │         /opsx:apply подхватывает
      │                │         там, где вы остановились
      │                │
      │                └── Создает ОДИН артефакт, показывает, что разблокировано
      │
      └── Создает структуру изменения, ждет указаний
```

### Кастомные схемы

Создавайте кастомные рабочие процессы, используя команды управления схемами:

```bash
# Создать новую схему с нуля (интерактивно)
openspec schema init my-workflow

# Или форкнуть существующую схему как отправную точку
openspec schema fork spec-driven my-workflow

# Валидировать структуру схемы
openspec schema validate my-workflow

# Посмотреть, откуда разрешается схема (полезно для отладки)
openspec schema which my-workflow
```

Схемы хранятся в `openspec/schemas/` (локально в проекте, под контролем версий) или `~/.local/share/openspec/schemas/` (глобально для пользователя).

**Структура схемы:**
```
openspec/schemas/research-first/
├── schema.yaml
└── templates/
    ├── research.md
    ├── proposal.md
    └── tasks.md
```

**Пример schema.yaml:**
```yaml
name: research-first
artifacts:
  - id: research        # Добавлено перед proposal
    generates: research.md
    requires: []

  - id: proposal
    generates: proposal.md
    requires: [research]  # Теперь зависит от research

  - id: tasks
    generates: tasks.md
    requires: [proposal]
```

**Граф зависимостей:**
```
   research ──► proposal ──► tasks
```

### Итог

| Аспект | Legacy | OPSX |
|--------|----------|------|
| **Шаблоны** | Жестко закодированный TypeScript | Внешний YAML + Markdown |
| **Зависимости** | Нет (все сразу) | DAG с топологической сортировкой |
| **Состояние** | Ментальная модель фаз | Существование в файловой системе |
| **Настройка** | Редактировать исходник, пересобирать | Создать schema.yaml |
| **Итерация** | Заблокированные фазы | Гибкость, редактируйте что угодно |
| **Поддержка редакторов** | 18+ классов конфигураторов | Единая директория навыков |

## Схемы

Схемы определяют, какие артефакты существуют и их зависимости. В настоящее время доступны:

- **spec-driven** (по умолчанию): proposal → specs → design → tasks

```bash
# Список доступных схем
openspec schemas

# Посмотреть все схемы с их источниками разрешения
openspec schema which --all

# Создать новую схему интерактивно
openspec schema init my-workflow

# Форкнуть существующую схему для настройки
openspec schema fork spec-driven my-workflow

# Валидировать структуру схемы перед использованием
openspec schema validate my-workflow
```

## Советы

- Используйте `/opsx:explore`, чтобы обдумать идею перед тем, как фиксировать изменение
- `/opsx:ff`, когда вы знаете, чего хотите, `/opsx:continue`, когда исследуете
- Во время `/opsx:apply`, если что-то не так — исправьте артефакт, затем продолжайте
- Задачи отслеживают прогресс через чекбоксы в `tasks.md`
- Проверяйте статус в любое время: `openspec status --change "name"`

## Обратная связь

Это черновой вариант. Это намеренно — мы изучаем, что работает.

Нашли баг? Есть идеи? Присоединяйтесь к нам в [Discord](https://discord.gg/YctCnvvshC) или откройте issue на [GitHub](https://github.com/Fission-AI/openspec/issues).
